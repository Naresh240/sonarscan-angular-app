stages:
  - build
  - test
  - quality_gate

variables:
  SONAR_URL: "http://34.132.236.40:9000"
  PROJECT_KEY: "angularproject"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  COVERAGE_THRESHOLD: "55.0"
  COVERAGE_FILE: "coverage/lcov.info"

.default_node_image: &default_node_image
  image:
    name: node:20
    entrypoint: [""]

.common_tools: &common_tools
  before_script:
    - apt-get update && apt-get install -y chromium wget unzip bc
    - ln -s /usr/bin/chromium /usr/bin/google-chrome || true
    - export CHROME_BIN=/usr/bin/chromium
    - npm ci

# -------------------------
# Build Stage
# -------------------------
build:
  stage: build
  <<: *default_node_image
  <<: *common_tools
  script:
    - echo "Building Angular app..."
    - npx ng build --configuration production
  artifacts:
    paths:
      - node_modules/
      - dist/
    expire_in: 1 hour

# -------------------------
# Test Stage (Coverage Validation)
# -------------------------
test:
  stage: test
  <<: *default_node_image
  <<: *common_tools
  dependencies:
    - build
  script:
    - rm -rf coverage/ .sonar/
    - echo "Running unit tests with coverage..."
    - npx ng test --watch=false --browsers=ChromeHeadlessCI --code-coverage

    # Validate coverage file exists
    - |
      if [ ! -f "$COVERAGE_FILE" ]; then
        echo "ERROR: $COVERAGE_FILE not found"
        exit 1
      fi
      
    - |
      # Lines
      TOTAL_LINES=$(grep -c "^DA:" "$COVERAGE_FILE")
      COVERED_LINES=$(grep -c "^DA:[0-9]*,[1-9][0-9]*" "$COVERAGE_FILE")

      # Branches
      TOTAL_BRANCHES=$(grep -c "^BRDA:" "$COVERAGE_FILE")
      COVERED_BRANCHES=$(grep "^BRDA:" "$COVERAGE_FILE" | awk -F"," '$4 == 1' | wc -l)

      # Apply SonarQube formula
      TOTAL=$((TOTAL_LINES + TOTAL_BRANCHES))
      COVERED=$((COVERED_LINES + COVERED_BRANCHES))

      if [ "$TOTAL" -gt 0 ]; then
        COVERAGE=$(echo "scale=2; 100 * $COVERED / $TOTAL" | bc)
      else
        COVERAGE=0
      fi

      echo "Line Coverage   = $(echo "scale=2; 100 * $COVERED_LINES / $TOTAL_LINES" | bc)%"
      echo "Branch Coverage = $(echo "scale=2; 100 * $COVERED_BRANCHES / $TOTAL_BRANCHES" | bc)%"
      echo "Overall Coverage (GitLab, Sonar formula) = $COVERAGE%"

      if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
        echo "❌ Failing: Coverage ($COVERAGE%) < threshold ($COVERAGE_THRESHOLD%)"
        exit 1
      else
        echo "✅ Coverage OK: $COVERAGE% >= $COVERAGE_THRESHOLD%"
      fi
  artifacts:
    paths:
      - coverage/
    expire_in: 1 hour
    
# -----------------------------------
# Quality Gate (SonarQube + Coverage)
# -----------------------------------
quality_gate:
  stage: quality_gate
  image: sonarsource/sonar-scanner-cli:latest
  dependencies:
    - test
  script:
    - echo "Running SonarQube analysis..."
    - |
      if [ ! -f "$COVERAGE_FILE" ]; then
        echo "No lcov.info found for SonarQube at $COVERAGE_FILE"; exit 1;
      fi

      sonar-scanner \
        -Dsonar.projectKey=$PROJECT_KEY \
        -Dsonar.javascript.lcov.reportPaths=$COVERAGE_FILE \
        -Dsonar.host.url=$SONAR_URL \
        -Dsonar.login=$SONAR_TOKEN

  artifacts:
    paths:
      - coverage/
    expire_in: 1 hour
